<h1 align="center">Гайд по парсерам и импортам
<img src="https://github.com/blackcater/blackcater/raw/main/images/Hi.gif" height="32"/></h1>
<h3 align="center">beta руководство как, зачем и почему</h3>

## Оглавление

**Глава 1**

- [Парсеры](#Парсеры) - Парсеры и точка.
- [Импорты](#Импорты) - Импорты и точка.

____

# Парсеры

**Парсер** - это код (скрипт) в нашем случае написан на `PHP`, сейчас по пунктам распишу, почему и зачем.

1. Парсер в первую очередь собирает какую-либо информация, опять же в нашем случае это либо `Сайт` либо `Клиентский фид`
- 1.1 Если все же стоит задача написать парсер с нуля, то нам должны предоставить источник или сам просим источник (т.е. сайт)
  . После создаем в проекте `parse` , папку с названием проекта с которого будем парсить (Например название проекта `Донстрой` - папка будет называться `donstroy`) уже внутри этой папки мы создаем файл `index.php`. И  там уже пишем свой код.
- 1.2 Каждый раз когда делаем какие-либо махинации с кодом **СРАЗУ ДАМПИМ** ваше творение и проверяем каждый шаг.
- 1.3 После того, как написали ваш код, проверяем создается ли `base.xml` ? Если да, то еще раз запускаем смотрим все ли ок и только потом пушим.
  ПРИМЕР НАШЕГО КЛАССА ПРИ ПАРСИНГЕ САЙТЕ
    ```
   $parser = new \parser\v2\Parser(
   [
       'livingComplex' => '', - НАЗВАНИЕ ЖК, ЕСЛИ ЭТО ОДИН ПРОЕКТ, МЫ СРАЗУ ВСТАВЛЯЕМ СЮДА НАЗВАНИЕ ЖК, ИНАЧЕ ОСТАВЛЯЕМ ПУСТЫМ ЕСЛИ МЫ ПАРСИМ БОЛЬШЕ ОДНОГО ПРОЕКТА И ЖК УЖЕ ЗАПОЛНЯЕМ ВНУТРИ МАССИВА flat
       'folder' => dirname(__FILE__) . DIRECTORY_SEPARATOR, - ОПЦИЯ ЧТОБЫ КЛАСС ПОНИМАЛ КУДА МЫ КЛАДЕМ НАШ base.xml
       'parser' => [
           'class' => 'Curl',
           'params' => [
               'handler' => [],
               'header' => []
           ]
       ],
       'url' => [
           [
               'url' => 'ССЫЛКА НА ОТКУДА ПАРСИМ',
               'method' => 'get' - МЕТОД КОТОРЫЙ НУЖЕН ДЛЯ CURL,
               'type' => 'json', - ТИП, КОТОРЫЙ МЫ ХОТИМ ВИДЕТЬ, ЕСЛИ ЭТО API, ТО ТИП БУДЕТ JSON, ИНАЧЕ ЕСЛИ МЫ ХОТИМ СПАРСИТЬ HTML ТО ТИП БУДЕТ URL
           ],
       ],
   ]
   );
   ```
- 1.4 Обязательные теги, чтобы создавался наш любимый `base.xml`:
    - **id** - (Это айди конекретного лота и оно должно быть уникальным). Ни в коем случае не подставляем рандомные id из клиентских фидов или сайтов.
      Для отпимизации id нашего класса в массиве `flat` существует функция, которая генерирует id из других параметров
        ```
         $id = filter_var($square . $rooms . $korp . $floor, FILTER_SANITIZE_NUMBER_INT),
        ```
      >`$square` = площадь лота ~ 24.5 (Площадь указывается через точку, а не через ~~запятую~~).

      >`$rooms` или `$num` = комнатность лота, передается цифрой, если лот является студией мы передаем буквой `s`.

      >`$korp` = корпус нашего лота, его может и не быть, тогда мы можем пропустить эту переменную или подставить в filter_var 1 (Ну это не так критично)

      >`$floor` = этаж лота (тоже обычная цифра)

    - **num** - Комнатность лота, тоже является обязательным параметром (Передается цифрой, иначе если студия передаем букву `s`).
    - **square** - Площадь лота, если с плавающей точкой передаем его через точку вот так `24.5`, но не так ~~24.5~~
    - **floor** - Этаж лота, передаем цифрой.
    - **price** - Цена лота, тоже передаем цифрой.
    - **section** - Секция (Подъезд) - нужна для привязки поэтажек. Секция не везде существует, лучше уточнять по этому поводу.
    - **imagePlan** - Ссылка на планировку лота.
    - **korp** - Корпус. Корпус тоже не всегда есть и тоже лучше уточнить.

2. Если дали источник `клиентский фид` и он кастомный, то надо переделать под наш формат ШАБЛОН - `default` в импортах.
    - 2.1  Первым делом распарсим клиентский фид и данные запишем в такой же массив `flat` как и если бы мы парсили все через сайт. И обработаем через наш класс:
        ```
        $parser->init(function ($content, $item, $element) use (&$flat) {
        foreach ($flat as $row){
            $element->getList()->add($row);
        }
        });
        ```
    - 2.2 Если нас попросили просто что-то заменить в клиентском и это по сути возможно, тогда мы парсим `клиентский фид`, меняем что нам нужно и сохраняем вот так:
        ```
        file_put_contents($workDir . $baseXMLFile, $dom->saveXML());
        ```

____

# Импорты

**Импорты** - это функционал, который из парсера или клиентского фида добавляет информацию к нам базу (ИМЕННО В БАЗУ), площадки типа Авито, Циана или Яндекса тут вообще не причем, вся информация через импорты кладется чисто к нам базу и точка.

1. Существуют 3 админки - MSK, REGIONS, SPB - и каждый нужный импорт мы обязательно подключаем в свой регион.
2. Также внутри любого импорта содержится информация такого характера:
   ![Image](https://thumb.cloud.mail.ru/weblink/thumb/xw1/NzgK/3oZXN74Xo)
   > - 1 - Тип импорта (Квартиры,Коммерция,Паркинг) - выбираем тот, который нам необходим.

   > - 2 - Уникальное имя пользователя мы берем из ссылки парсера - http://parse.mediapronet.ru/pik_google/?open=1 (Здесь допустим `pik_google`)

   > - 3 - `ШАБЛОНЫ` САМОЕ ГЛАВНОЕ . Существует 3 типа шаблона или более, слышал только 3-х. Это:
   >>1 - `default` - Наш основной шаблон для наших типов парсеров.
   >>>2 - `yandex_phase` - Шаблон для формата яндекс (для клиентских фидов) - лучше сначала проверять в валидаторе.
   >>>>3 - `cian_new` - Шаблон для формата циан (для клиентских фидов) - лучше сначала проверять в валидаторе.

   > - 4 - ссылка на сам парсер

   > - 5 - Указываем продавца, лучше спросить у Оли если не знаем кого указывать

   > - 6 - Статус включить (естественно)

    > - 7 - Включить максимальные цены = "Да"

    > - 8 - Обновление цены жк = "Да" 

Далее просто жмем сохранить и импорт готов.

После того как сделали парсер и импорт просьба сразу в задаче отписать и скинуть ссылки на парсер и импорт. Пример:

parser - ссылка на парсер (http://parse.mediapronet.ru/pik_flat_feed_region/?open=1)

import - ссылка на импорт (https://admin.novostroy-regions.ru/exchange/tools/update/id/528)

New info for Diana : `в прасерах квартир шаблона default появилось новое поле external_id. Заполяем его, когда парсим клиенсткий фид и пересобираем в наш формат default, записывая в него клиенсткий айдишник лота`
